context("load data")

base64_iris <- "WAoAAAACAAMEBAACAwAAAAMTAAAABQAAAA4AAACWQBRmZmZmZmZAE5mZmZmZmkASzMzMzMzNQBJmZmZmZmZAFAAAAAAAAEAVmZmZmZmaQBJmZmZmZmZAFAAAAAAAAEARmZmZmZmaQBOZmZmZmZpAFZmZmZmZmkATMzMzMzMzQBMzMzMzMzNAETMzMzMzM0AXMzMzMzMzQBbMzMzMzM1AFZmZmZmZmkAUZmZmZmZmQBbMzMzMzM1AFGZmZmZmZkAVmZmZmZmaQBRmZmZmZmZAEmZmZmZmZkAUZmZmZmZmQBMzMzMzMzNAFAAAAAAAAEAUAAAAAAAAQBTMzMzMzM1AFMzMzMzMzUASzMzMzMzNQBMzMzMzMzNAFZmZmZmZmkAUzMzMzMzNQBYAAAAAAABAE5mZmZmZmkAUAAAAAAAAQBYAAAAAAABAE5mZmZmZmkARmZmZmZmaQBRmZmZmZmZAFAAAAAAAAEASAAAAAAAAQBGZmZmZmZpAFAAAAAAAAEAUZmZmZmZmQBMzMzMzMzNAFGZmZmZmZkASZmZmZmZmQBUzMzMzMzNAFAAAAAAAAEAcAAAAAAAAQBmZmZmZmZpAG5mZmZmZmkAWAAAAAAAAQBoAAAAAAABAFszMzMzMzUAZMzMzMzMzQBOZmZmZmZpAGmZmZmZmZkAUzMzMzMzNQBQAAAAAAABAF5mZmZmZmkAYAAAAAAAAQBhmZmZmZmZAFmZmZmZmZkAazMzMzMzNQBZmZmZmZmZAFzMzMzMzM0AYzMzMzMzNQBZmZmZmZmZAF5mZmZmZmkAYZmZmZmZmQBkzMzMzMzNAGGZmZmZmZkAZmZmZmZmaQBpmZmZmZmZAGzMzMzMzM0AazMzMzMzNQBgAAAAAAABAFszMzMzMzUAWAAAAAAAAQBYAAAAAAABAFzMzMzMzM0AYAAAAAAAAQBWZmZmZmZpAGAAAAAAAAEAazMzMzMzNQBkzMzMzMzNAFmZmZmZmZkAWAAAAAAAAQBYAAAAAAABAGGZmZmZmZkAXMzMzMzMzQBQAAAAAAABAFmZmZmZmZkAWzMzMzMzNQBbMzMzMzM1AGMzMzMzMzUAUZmZmZmZmQBbMzMzMzM1AGTMzMzMzM0AXMzMzMzMzQBxmZmZmZmZAGTMzMzMzM0AaAAAAAAAAQB5mZmZmZmZAE5mZmZmZmkAdMzMzMzMzQBrMzMzM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zMzMzMzNQBTMzMzMzM1AFAAAAAAAAEAUzMzMzMzNQBWZmZmZmZpAFGZmZmZmZgAAAA4AAACWP8mZmZmZmZo/yZmZmZmZmj/JmZmZmZmaP8mZmZmZmZo/yZmZmZmZmj/ZmZmZmZmaP9MzMzMzMzM/yZmZmZmZmj/JmZmZmZmaP7mZmZmZmZo/yZmZmZmZmj/JmZmZmZmaP7mZmZmZmZo/uZmZmZmZmj/JmZmZmZmaP9mZmZmZmZo/2ZmZmZmZmj/TMzMzMzMzP9MzMzMzMzM/0zMzMzMzMz/JmZmZmZmaP9mZmZmZmZo/yZmZmZmZmj/gAAAAAAAAP8mZmZmZmZo/yZmZmZmZmj/ZmZmZmZmaP8mZmZmZmZo/yZmZmZmZmj/JmZmZmZmaP8mZmZmZmZo/2ZmZmZmZmj+5mZmZmZmaP8mZmZmZmZo/yZmZmZmZmj/JmZmZmZmaP8mZmZmZmZo/uZmZmZmZmj/JmZmZmZmaP8mZmZmZmZo/0zMzMzMzMz/TMzMzMzMzP8mZmZmZmZo/4zMzMzMzMz/ZmZmZmZmaP9MzMzMzMzM/yZmZmZmZmj/JmZmZmZmaP8mZmZmZmZo/yZmZmZmZmj/2ZmZmZmZmP/gAAAAAAAA/+AAAAAAAAD/0zMzMzMzNP/gAAAAAAAA/9MzMzMzMzT/5mZmZmZmaP/AAAAAAAAA/9MzMzMzMzT/2ZmZmZmZmP/AAAAAAAAA/+AAAAAAAAD/wAAAAAAAAP/ZmZmZmZmY/9MzMzMzMzT/2ZmZmZmZmP/gAAAAAAAA/8AAAAAAAAD/4AAAAAAAAP/GZmZmZmZo//MzMzMzMzT/0zMzMzMzNP/gAAAAAAAA/8zMzMzMzMz/0zMzMzMzNP/ZmZmZmZmY/9mZmZmZmZj/7MzMzMzMzP/gAAAAAAAA/8AAAAAAAAD/xmZmZmZmaP/AAAAAAAAA/8zMzMzMzMz/5mZmZmZmaP/gAAAAAAAA/+ZmZmZmZmj/4AAAAAAAAP/TMzMzMzM0/9MzMzMzMzT/0zMzMzMzNP/MzMzMzMzM/9mZmZmZmZj/zMzMzMzMzP/AAAAAAAAA/9MzMzMzMzT/zMzMzMzMzP/TMzMzMzM0/9MzMzMzMzT/xmZmZmZmaP/TMzMzMzM1ABAAAAAAAAD/+ZmZmZmZmQADMzMzMzM0//MzMzMzMzUABmZmZmZmaQADMzMzMzM0/+zMzMzMzMz/8zMzMzMzNP/zMzMzMzM1ABAAAAAAAAEAAAAAAAAAAP/5mZmZmZmZAAMzMzMzMzUAAAAAAAAAAQAMzMzMzMzNAAmZmZmZmZj/8zMzMzMzNQAGZmZmZmZpAAmZmZmZmZj/4AAAAAAAAQAJmZmZmZmZAAAAAAAAAAEAAAAAAAAAAP/zMzMzMzM1AAMzMzMzMzT/8zMzMzMzNP/zMzMzMzM0//MzMzMzMzUAAzMzMzMzNP/mZmZmZmZo//mZmZmZmZkAAAAAAAAAAQAGZmZmZmZo/+AAAAAAAAD/2ZmZmZmZmQAJmZmZmZmZAAzMzMzMzMz/8zMzMzMzNP/zMzMzMzM1AAMzMzMzMzUADMzMzMzMzQAJmZmZmZmY//mZmZmZmZkACZmZmZmZmQAQAAAAAAABAAmZmZmZmZj/+ZmZmZmZmQAAAAAAAAABAAmZmZmZmZj/8zMzMzMzNAAADDQAAAJYAAAABAAAAAQAAAAEAAAABAAAAAQAAAAEAAAABAAAAAQAAAAEAAAABAAAAAQAAAAEAAAABAAAAAQAAAAEAAAABAAAAAQAAAAEAAAABAAAAAQAAAAEAAAABAAAAAQAAAAEAAAABAAAAAQAAAAEAAAABAAAAAQAAAAEAAAABAAAAAQAAAAEAAAABAAAAAQAAAAEAAAABAAAAAQAAAAEAAAABAAAAAQAAAAEAAAABAAAAAQAAAAEAAAABAAAAAQAAAAEAAAABAAAAAQAAAAIAAAACAAAAAgAAAAIAAAACAAAAAgAAAAIAAAACAAAAAgAAAAIAAAACAAAAAgAAAAIAAAACAAAAAgAAAAIAAAACAAAAAgAAAAIAAAACAAAAAgAAAAIAAAACAAAAAgAAAAIAAAACAAAAAgAAAAIAAAACAAAAAgAAAAIAAAACAAAAAgAAAAIAAAACAAAAAgAAAAIAAAACAAAAAgAAAAIAAAACAAAAAgAAAAIAAAACAAAAAgAAAAIAAAACAAAAAgAAAAIAAAACAAAAAwAAAAMAAAADAAAAAwAAAAMAAAADAAAAAwAAAAMAAAADAAAAAwAAAAMAAAADAAAAAwAAAAMAAAADAAAAAwAAAAMAAAADAAAAAwAAAAMAAAADAAAAAwAAAAMAAAADAAAAAwAAAAMAAAADAAAAAwAAAAMAAAADAAAAAwAAAAMAAAADAAAAAwAAAAMAAAADAAAAAwAAAAMAAAADAAAAAwAAAAMAAAADAAAAAwAAAAMAAAADAAAAAwAAAAMAAAADAAAAAwAAAAMAAAQCAAAAAQAEAAkAAAAGbGV2ZWxzAAAAEAAAAAMABAAJAAAABnNldG9zYQAEAAkAAAAKdmVyc2ljb2xvcgAEAAkAAAAJdmlyZ2luaWNhAAAEAgAAAAEABAAJAAAABWNsYXNzAAAAEAAAAAEABAAJAAAABmZhY3RvcgAAAP4AAAQCAAAAAQAEAAkAAAAFbmFtZXMAAAAQAAAABQAEAAkAAAAMU2VwYWwuTGVuZ3RoAAQACQAAAAtTZXBhbC5XaWR0aAAEAAkAAAAMUGV0YWwuTGVuZ3RoAAQACQAAAAtQZXRhbC5XaWR0aAAEAAkAAAAHU3BlY2llcwAABAIAAAABAAQACQAAAAlyb3cubmFtZXMAAAANAAAAAoAAAAD///9qAAAEAgAAAv8AAAAQAAAAAQAEAAkAAAAKZGF0YS5mcmFtZQAAAP4="
base64_modified_iris_3 <- "WAoAAAACAAMEBAACAwAAAAMTAAAABQAAAA4AAAADQOhqAzMzMzNAE5mZmZmZmkASzMzMzMzNAAAADgAAAANADAAAAAAAAEAIAAAAAAAAQAmZmZmZmZoAAAAOAAAAAz/2ZmZmZmZmP/ZmZmZmZmY/9MzMzMzMzQAAAA4AAAADP8mZmZmZmZo/yZmZmZmZmj/JmZmZmZmaAAADDQAAAAMAAAABAAAAAQAAAAEAAAQCAAAAAQAEAAkAAAAGbGV2ZWxzAAAAEAAAAAMABAAJAAAABnNldG9zYQAEAAkAAAAKdmVyc2ljb2xvcgAEAAkAAAAJdmlyZ2luaWNhAAAEAgAAAAEABAAJAAAABWNsYXNzAAAAEAAAAAEABAAJAAAABmZhY3RvcgAAAP4AAAQCAAAAAQAEAAkAAAAFbmFtZXMAAAAQAAAABQAEAAkAAAAMU2VwYWwuTGVuZ3RoAAQACQAAAAtTZXBhbC5XaWR0aAAEAAkAAAAMUGV0YWwuTGVuZ3RoAAQACQAAAAtQZXRhbC5XaWR0aAAEAAkAAAAHU3BlY2llcwAABAIAAAABAAQACQAAAAlyb3cubmFtZXMAAAANAAAAAoAAAAAAAAADAAAEAgAAAv8AAAAQAAAAAQAEAAkAAAAKZGF0YS5mcmFtZQAAAP4="

# The first three rows from iris, but with Sepal.Length doubled
base64_scaled_iris_3 <- "WAoAAAACAAMEBAACAwAAAAMTAAAABQAAAA4AAAADQCRmZmZmZmZAI5mZmZmZmkAizMzMzMzNAAAADgAAAANADAAAAAAAAEAIAAAAAAAAQAmZmZmZmZoAAAAOAAAAAz/2ZmZmZmZmP/ZmZmZmZmY/9MzMzMzMzQAAAA4AAAADP8mZmZmZmZo/yZmZmZmZmj/JmZmZmZmaAAADDQAAAAMAAAABAAAAAQAAAAEAAAQCAAAAAQAEAAkAAAAGbGV2ZWxzAAAAEAAAAAMABAAJAAAABnNldG9zYQAEAAkAAAAKdmVyc2ljb2xvcgAEAAkAAAAJdmlyZ2luaWNhAAAEAgAAAAEABAAJAAAABWNsYXNzAAAAEAAAAAEABAAJAAAABmZhY3RvcgAAAP4AAAQCAAAAAQAEAAkAAAAFbmFtZXMAAAAQAAAABQAEAAkAAAAMU2VwYWwuTGVuZ3RoAAQACQAAAAtTZXBhbC5XaWR0aAAEAAkAAAAMUGV0YWwuTGVuZ3RoAAQACQAAAAtQZXRhbC5XaWR0aAAEAAkAAAAHU3BlY2llcwAABAIAAAABAAQACQAAAAlyb3cubmFtZXMAAAANAAAAAoAAAAAAAAADAAAEAgAAAv8AAAAQAAAAAQAEAAkAAAAKZGF0YS5mcmFtZQAAAP4="

test_that("cached data loaded as expected", {
  b <- load_rde_var(TRUE, {iris}, base64_iris)

  expect_equal(length(b), 5)
  expect_true(all.equal(b, iris))
})

test_that("new data loaded as expected", {
  b <- load_rde_var(FALSE, {iris}, base64_iris)

  expect_equal(length(b), 5)
  expect_true(all.equal(b, iris))
})

test_that("new data with multiple lines", {
  b <- load_rde_var(
    FALSE,
    {
      a <- head(iris, 3)
      a$Sepal.Length <- a$Sepal.Length * 2
      a
    },
    base64_scaled_iris_3
  )

  expect_equal(length(b), 5)
  expect_true(all.equal(b$Sepal.Length, head(iris, 3)$Sepal.Length * 2))
  expect_true(all.equal(b$Species, head(iris, 3)$Species))
})

test_that("difference between new data and cahced data causes warning", {
  expect_warning(
    load_rde_var(FALSE, {iris}, base64_modified_iris_3)
  )
})

test_that("when there is a difference between new data and cached data, the new data is returned (cache=FALSE)", {
  suppressWarnings({
    b <- load_rde_var(FALSE, {iris}, base64_modified_iris_3)
  })
  expect_true(all.equal(b, iris))
})

test_that("when new data produces error, cached data is returned", {
  b <- load_rde_var(FALSE, {stop("some error")}, base64_iris)

  expect_equal(length(b), 5)
  expect_true(all.equal(b, iris))
})

test_that("when new data produces error, message is raised", {
  expect_message(
    load_rde_var(FALSE, {stop("some error")}, base64_iris),
    "Error raised when loading new data"
  )
})

test_that("data load code can access variables from the calling environment", {
  mult <- 2
  b <- load_rde_var(
    FALSE,
    {
      a <- head(iris, 3)
      a$Sepal.Length <- a$Sepal.Length * mult
      a
    },
    base64_scaled_iris_3
  )

  expect_equal(length(b), 5)
  expect_true(all.equal(b$Sepal.Length, head(iris, 3)$Sepal.Length * 2))
  expect_true(all.equal(b$Species, head(iris, 3)$Species))
})

test_that("expressions in load code don't affect enclosing environment variables", {
  mult <- 1
  b <- load_rde_var(
    FALSE,
    {
      mult <- mult * 2
      a <- head(iris, 3)
      a$Sepal.Length <- a$Sepal.Length * mult
      expect_equal(mult, 2)
      a
    },
    base64_scaled_iris_3
  )

  expect_equal(mult, 1)
  expect_equal(length(b), 5)
  expect_true(all.equal(b$Sepal.Length, head(iris, 3)$Sepal.Length * 2))
  expect_true(all.equal(b$Species, head(iris, 3)$Species))
})
